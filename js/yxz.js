/// <reference path="json.js" />
/// <reference path="idangerous.swiper-1.9.1.min.js" />
/// <reference path="jquery-1.5.1.min.js" />
var yxzJson =
{
    "data": [
{ "warid": 1001, "name": "魔·于吉", "cutstrength": 8, "x": 40, "y": 146, "detail": "于吉，东汉末期的道士，被普遍认为是道教经典《太平经》的作者，为孙策所杀。", "type": "3,3,3,3,3,2", "itemlist": "3001,3002,3003,3004,2012,9002" },
{ "warid": 1002, "name": "魔·牛辅", "cutstrength": 8, "x": 224, "y": 114, "detail": "牛辅，董卓的女婿，任中郎将，征讨白波军，不能取胜。董卓被杀时，牛辅别屯于陕地。", "type": "3,3,3,3,3,2", "itemlist": "3005,3006,3007,3008,2023,9002" },
{ "warid": 1003, "name": "魔·孔融", "cutstrength": 8, "x": 442, "y": 156, "detail": "孔融，“建安七子”之首。曾任北军中侯、虎贲中郎将、北海相，时称孔北海。", "type": "3,3,3,3,3,2", "itemlist": "3001,3002,3003,3004,2012,9003" },
{ "warid": 1004, "name": "魔·吕玲绮", "cutstrength": 8, "x": 624, "y": 170, "detail": "为吕布与严氏所生之女孩，绝色美女且武艺娴熟，骑枣红战马，手拿方天戟。", "type": "3,3,3,3,3,2", "itemlist": "3005,3006,3007,3008,2001,9003" },
{ "warid": 1005, "name": "魔·马忠", "cutstrength": 8, "x": 40, "y": 174, "detail": "三国时期吴国将领，吴督吕蒙攻关羽，忠于章乡俘获关羽及其子关平、都督赵累等，遂定荆州。", "type": "3,3,3,3,3,2", "itemlist": "3009,3010,3011,3012,2012,9002" },
{ "warid": 1006, "name": "魔·潘璋", "cutstrength": 8, "x": 222, "y": 140, "detail": "潘璋年轻时家贫，跟随孙权后得到其赏识，加上其作战勇猛，不断升迁，其一生为孙权东征西讨。", "type": "3,3,3,3,3,2", "itemlist": "3013,3014,3015,3016,2023,9002" },
{ "warid": 1007, "name": "魔·臧霸", "cutstrength": 8, "x": 446, "y": 124, "detail": "年少时曾召集数人将获罪的父亲救出，此后四处流亡。在很多战役里，战功赫赫，官至镇东将军。", "type": "3,3,3,3,3,2", "itemlist": "3009,3010,3011,3012,2012,9002" },
{ "warid": 1008, "name": "魔·沮授", "cutstrength": 8, "x": 628, "y": 138, "detail": "常对袁绍提出良策，袁绍并不听从。官渡之战大败，沮授未及逃走，因拒降被曹操处死。", "type": "3,3,3,3,3,2", "itemlist": "3013,3014,3015,3016,2023,9002" },
{ "warid": 1009, "name": "魔·高顺", "cutstrength": 8, "x": 40, "y": 146, "detail": "吕布帐下中郎将，为人清白有威严，不好饮酒，所统率的部队精锐非常，号称“陷阵营”。", "type": "3,3,3,3,3,2", "itemlist": "3017,3018,3019,3020,2012,9002" },
{ "warid": 1010, "name": "魔·沙摩柯", "cutstrength": 8, "x": 224, "y": 114, "detail": "汉末三国时五溪蛮夷首领。蜀章武初，刘备亲自领兵攻孙权，以金锦爵赏诱沙摩柯助战。", "type": "3,3,3,3,3,2", "itemlist": "3021,3022,3023,3024,2023,9002" },
{ "warid": 1011, "name": "魔·陈宫", "cutstrength": 8, "x": 442, "y": 156, "detail": "东汉末年吕布帐下谋士、大将，性情刚直，足智多谋，年少时与海内知名之士相互结交。", "type": "3,3,3,3,3,2", "itemlist": "3017,3018,3019,3020,2012,9003" },
{ "warid": 1012, "name": "魔·夏侯霸", "cutstrength": 8, "x": 624, "y": 170, "detail": "本为曹魏武将，后因司马懿诛曹爽一族，夏侯霸身为曹氏宗室而心怀不安，遂投降蜀汉。", "type": "3,3,3,3,3,2", "itemlist": "3021,3022,3023,3024,2023,9003" },
{ "warid": 1013, "name": "魔·潘凤", "cutstrength": 8, "x": 40, "y": 174, "detail": "冀州牧韩馥部下的上将。十八路诸侯讨伐董卓之时，奉命前往挑战董卓部下大将华雄，不敌被斩。", "type": "3,3,3,3,3,2", "itemlist": "3025,3026,3027,3028,2034,9002" },
{ "warid": 1014, "name": "魔·何太后", "cutstrength": 8, "x": 222, "y": 140, "detail": "少帝刘辩生母，被立为皇后。少帝继位后，为皇太后，董卓进京，为董卓毒杀。", "type": "3,3,3,3,3,2", "itemlist": "3029,3030,3031,3032,2045,9002" },
{ "warid": 1015, "name": "魔·鞠义", "cutstrength": 8, "x": 446, "y": 124, "detail": "东汉末年军阀袁绍部下的将领，能征善战，屡建战功。后来由于自恃功高而骄纵，被袁绍所杀。", "type": "3,3,3,3,3,2", "itemlist": "3025,3026,3027,3028,2034,9003" },
{ "warid": 1016, "name": "魔·甄姬", "cutstrength": 8, "x": 628, "y": 138, "detail": "传誉千古的一代皇后，而且是中国古代文学史上第一位女诗人，是甄氏家族史上一位绝世女圣贤。", "type": "3,3,3,3,3,2", "itemlist": "3029,3030,3031,3032,2045,9003" },
{ "warid": 1017, "name": "魔·关凤", "cutstrength": 8, "x": 40, "y": 146, "detail": "关羽之女，孙权曾欲为子娶之，但被关公以“虎女安嫁犬子”拒绝。", "type": "3,3,3,3,3,2", "itemlist": "3033,3034,3035,3036,2056,9002" },
{ "warid": 1018, "name": "魔·王双", "cutstrength": 8, "x": 224, "y": 114, "detail": "三国时曹魏将领。诸葛亮出攻祁山。王双率领军队追击诸葛亮，为蜀军所斩。", "type": "3,3,3,3,3,2", "itemlist": "3037,3038,3039,3040,2067,9002" },
{ "warid": 1019, "name": "魔·张绣", "cutstrength": 8, "x": 442, "y": 156, "detail": "东汉末年割据宛城的军阀，汉末群雄之一。初随张济征伐，张济死后与刘表连和。", "type": "3,3,3,3,3,2", "itemlist": "3033,3034,3035,3036,2056,9003" },
{ "warid": 1020, "name": "魔·陶谦", "cutstrength": 8, "x": 624, "y": 170, "detail": "董卓被杀后，各路军阀陷入混战，陶谦加入了袁术、公孙瓒的阵营，对抗袁绍、曹操。", "type": "3,3,3,3,3,2", "itemlist": "3037,3038,3039,3040,2067,9003" },
{ "warid": 1021, "name": "魔·马云禄", "cutstrength": 8, "x": 40, "y": 174, "detail": "马超的妹妹，自幼习武，女中无双。在为马腾复仇的战事中跟随马超来到中原，与赵云一见钟情。", "type": "3,3,3,3,3,2", "itemlist": "3041,3042,3043,3044,2056,9002" },
{ "warid": 1022, "name": "魔·邓艾", "cutstrength": 8, "x": 222, "y": 140, "detail": "三国时期魏国将领。其人文武全才，深谙兵法，对内政也颇有建树，是魏国综合能力最强的将领。", "type": "3,3,3,3,3,2", "itemlist": "3045,3046,3047,3048,2045,9002" },
{ "warid": 1023, "name": "魔·夏侯涓", "cutstrength": 8, "x": 446, "y": 124, "detail": "夏侯霸之从妹，张飞之妻，所生二女为蜀汉后主刘禅皇后。", "type": "3,3,3,3,3,2", "itemlist": "3041,3042,3043,3044,2056,9003" },
{ "warid": 1024, "name": "魔·赵云", "cutstrength": 8, "x": 628, "y": 138, "detail": "赵云，字子龙，蜀汉“五虎将”之一，长坂坡七进七出，为当世少有的虎将。", "type": "3,3,3,3,3,2", "itemlist": "3045,3046,3047,3048,2045,9003" }
    ]
};


var yxzData = null;
//{ "leftRS": 2,"leftbuy":1, "data": [
//        { "warid": 1001, "canPK": 1 },
//        { "warid": 1002, "canPK": 0 },
//{ "warid": 1003, "canPK": 0 },
//{ "warid": 1004, "canPK": 0 },
//{ "warid": 1001, "canPK": 0 }
//    ]
//};
var battleSwiperYxz;
var yxzNowPage = 0;

var showYxz = function (json) {
    if (json != null)
        yxzData = JSON.parse(json);
    var div = document.createElement("div");
    div.id = "yxzDialog";
    $(div).html("<div id='yxzClose'></div><div class='heroNameBg fontstyle'id='rescount'></div><div id='addrescount'class='u_add'></div><div id='yxz'><img id='yxztitle'src='res/yxz/title.png'/><div id='yxzSwiper'class='swiper-container battleSwiper'><div class='map'id='yxzMap'></div></div></div>");
    document.body.appendChild(div);

    var scale = height / 480;
    var bwidth = width / scale;
    var tempLeft = -(854 * scale - width) / 2;

    if (pad) {
        $("#yxzClose").css({ "zoom": padScale });
    }

    $("#yxz").css({ "width": bwidth, "height": 480, "zoom": scale, "background": "url(res/yxz/Mapbg.jpg) no-repeat" });
    $("#yxztitle").css({ "left": (bwidth - 272) / 2, "position": "absolute" });

    $("#rescount").css({ "left": (bwidth - 186) / 2, "top": 435,"zoom":scale, "z-index": 2 }).html("重置关卡次数：<font style='color:#00ff00;'>" + yxzData.leftRS + "</font>");;
    $("#addrescount").css({ "left": (bwidth - 186) / 2 + 160, "top": 431, "zoom": scale, "z-index": 2 });

    ShowYxzMap(0);
    $("#yxzSwiper").css({ "width": 854, "height": 480, "overflow": "hidden" });
    $("#yxzMap").css({ "left": tempLeft })

    //购买次数
    $("#addrescount,#rescount").bind("touchend", function () {
        $(this).css({ "-webkit-transform": "scale(1)" });
        if (cancel())
            return;
        var maskDiv = document.createElement("div");
        maskDiv.id = "tempMask";
        $(maskDiv).css({ "width": width, "height": height, "top": "0" });
        document.body.appendChild(maskDiv);

        if (yxzData.leftbuy == 0) {
            $("#temp").html("<div id='mess3'><div id='q_title'style='left:70px;'><div id='q_titleLeft'></div><div id='q_titleCenter'><div id='q_titleContext'style='background-image:url(res/public/title/31.png);'></div></div><div id='q_titleRight'></div></div><div id='t_waikuan'><div class='q_jiao q_shangjiao'></div><div class='q_jiao q_xiajiao'></div><div class='q_jiao q_zuojiao'></div><div class='q_jiao q_youjiao'></div><div class='q_shangwaibian'></div><div class='q_xiawaibian'></div><div class='q_zuowaibian'></div><div class='q_youwaibian'></div></div><div id='dialogclose'></div><div id='rope'></div><div id='tempDialog3'><div id='lottery_content3'>今日还可购买<font style='color:#26E50E;'>" + yxzData.leftbuy + "</font>次英雄志重置数<br/>可购买次数不足,提升VIP等级可购买更多次</div></div><div id='shopOkBtn'class='ShopBtn'><div class='btn'><div class='btn1'></div><div class='btn2'>充值</div><div class='btn3'></div></div></div><div id='shopCancelBtn'class='ShopBtn'><div class='btn'><div class='btn1'></div><div class='btn2'>取消</div><div class='btn3'></div></div></div></div>");
        }
        else {
            $("#temp").html("<div id='mess3'><div id='q_title'style='left:70px;'><div id='q_titleLeft'></div><div id='q_titleCenter'><div id='q_titleContext'style='background-image:url(res/public/title/31.png);'></div></div><div id='q_titleRight'></div></div><div id='t_waikuan'><div class='q_jiao q_shangjiao'></div><div class='q_jiao q_xiajiao'></div><div class='q_jiao q_zuojiao'></div><div class='q_jiao q_youjiao'></div><div class='q_shangwaibian'></div><div class='q_xiawaibian'></div><div class='q_zuowaibian'></div><div class='q_youwaibian'></div></div><div id='dialogclose'></div><div id='rope'></div><div id='tempDialog3'><div id='lottery_content3'>今日还可购买<font style='color:#26E50E;'>" + yxzData.leftbuy + "</font>次英雄志重置数<br/>是否花费<font style='color:#26E50E;'>" + yxzData.gold + "</font>萌币,增加一次英雄志重置数?</div></div><div id='shopOkBtn'class='ShopBtn'><div class='btn'><div class='btn1'></div><div class='btn2'>购买</div><div class='btn3'></div></div></div><div id='shopCancelBtn'class='ShopBtn'><div class='btn'><div class='btn1'></div><div class='btn2'>取消</div><div class='btn3'></div></div></div></div>");
        }
        $("#mess3").css({ "left": (width - 476) / 2, "top": (height - 279) / 2 });
        if (pad) $("#mess3").css({ "zoom": sp, "left": (width - 476 * sp) / 2 / sp, "top": (height - 279 * sp) / 2 / sp });

        //绑定事件
        $("#shopCancelBtn,#dialogclose").bind("touchend", function () {
            if (cancel())
                return;
            window.GameMainClass.playEffectSound("close");
            $(this).css({ "-webkit-transform": "scale(1)" });
            $("#temp").html("");
            $("#tempMask").remove();
        }).bind("touchstart", function () {
            $(this).css({ "-webkit-transform": "scale(0.8)" });
            begin();
        }).bind("touchmove", function () {
            $(this).css({ "-webkit-transform": "scale(1)" });
            move();
        })

        //绑定购买事件
        $("#shopOkBtn").bind("touchend", function () {
            if (cancel())
                return;
            window.GameMainClass.playEffectSound("icon");
            //判断萌币是否足够
            if (yxzData.leftbuy == 0) {
                $("#temp").html("");
                $("#tempMask").remove();
                $("#yxzDialog").remove();
                loadRecharge();
                return;
            }
            if (userJson.gold < 2) {
                showTextMess("萌币不足", 2);
                return;
            }
            $(this).css({ "-webkit-transform": "scale(1)" });
            window.GameMainClass.sendRequestJson(184, "", "bugYxzTime");
        }).bind("touchstart", function () {
            $(this).css({ "-webkit-transform": "scale(1)" });
            begin();
        }).bind("touchmove", function () {
            $(this).css({ "-webkit-transform": "scale(0.8)" });
            move();
        })

    }).bind("touchmove", function () {
        $(this).css({ "-webkit-transform": "scale(1)" });
        move();
    }).bind("touchstart", function () {
        $(this).css({ "-webkit-transform": "scale(0.8)" });
        begin();
    })


    //绑定关闭事件
    $("#yxzClose").bind("touchend", function () {
        $(this).css({ "-webkit-transform": "scale(1)" });
        if (!cancel()) {
            battleSwiperYxz = null;
            $("#yxzDialog").remove();
            window.GameMainClass.playEffectSound("close");
        }
    }).bind("touchmove", function () {
        $(this).css({ "-webkit-transform": "scale(1)" });
        move();
    }).bind("touchstart", function () {
        $(this).css({ "-webkit-transform": "scale(0.8)" });
        begin();
    })
}

var ShowYxzMap = function (pageindex) {
    if (pageindex < 0 || pageindex > ((yxzData.data.length / 4) + (yxzData.data.length % 4 == 0 ? 0 : 1)) - 1)
        return;

    yxzNowPage = pageindex;
    var str = new Array();
    str.push("<div class='map_qg' style='background:url(res/yxz/" + ((pageindex % 2) == 0 ? "1" : "2") + ".png) no-repeat;height:219px;'></div>");
    var len = 0, startindex = pageindex * 4;
    for (; startindex < yxzData.data.length; startindex++) {
        str.push("<div class='yxzbody' ontouchmove='move();$(this).css({ \"-webkit-transform\": \"scale(1)\" });' ontouchstart='begin();window.GameMainClass.playEffectSound(\"icon\");$(this).css({ \"-webkit-transform\": \"scale(0.8)\" });' ontouchend='if (!cancel()) {showYxzHeroInfo(" + startindex + ");$(this).css({ \"-webkit-transform\": \"scale(1)\" });}' id='yb" + startindex + "' style='background-image:url(res/yxz/body/" + yxzJson.data[startindex].warid + (yxzData.data[startindex].canPK ? "a" : "b") + ".png);left:" + yxzJson.data[startindex].x + "px;top:" + yxzJson.data[startindex].y + "px;'>");
        if (!yxzData.data[startindex].canPK)
            str.push("<div class='yxzPassLabel'></div>");
        str.push("</div>");
        len++;
        if (len == 4)
            break;
    }
    var scale = height / 480;
    var tempLeft = -(854 * scale - width) / 2;
    var bwidth = width / scale;
    //上一页    
    str.push("<div id='pagePrevBtn' style='position:absolute;bottom:10px;left:" + ((tempLeft < 0 ? 0 - tempLeft : tempLeft) + 10) + "px;' ontouchstart='begin();window.GameMainClass.playEffectSound(\"icon\");$(this).css({ \"-webkit-transform\": \"scale(0.8)\" });' ontouchmove='move();'");
    str.push(" ontouchend='$(this).css({ \"-webkit-transform\": \"scale(1)\" });if (!cancel()) {ShowYxzMap(" + (pageindex - 1) + ");}'></div>");
    //下一页
    str.push("<div id='pageNextBtn' style='position:absolute;bottom:10px;left:" + (bwidth + (tempLeft < 0 ? 0 - tempLeft : tempLeft) - 60) + "px;' ontouchstart='begin();window.GameMainClass.playEffectSound(\"icon\");$(this).css({ \"-webkit-transform\": \"scale(0.8)\" });' ontouchmove='move();'");
    str.push(" ontouchend='$(this).css({ \"-webkit-transform\": \"scale(1)\" });if (!cancel()) {ShowYxzMap(" + (pageindex + 1) + ");}'></div>");

    $("#yxzMap").html(str.join(""));
}

//加载小地图
var showYxzHeroInfo = function (warindex) {

    var mapDialog = "<div id='title' style='left:" + (126 * 480 / height) + "px;'><div id='titleLeft'></div><div id='titleCenter'><div id='titleContext' style='background:url(res/yxz/messtitle.png) no-repeat;'></div></div><div id='titleRight'></div></div>";
    mapDialog += "<div id='close' ontouchmove='move();' ontouchstart='begin();window.GameMainClass.playEffectSound(\"close\");$(this).css({ \"-webkit-transform\": \"scale(0.8)\" });' ontouchend='if (!cancel()) {$(\"#yxzHeroInfo\").remove();$(\"#tempMask\").remove();}$(this).css({ \"-webkit-transform\": \"scale(1)\" });'></div>";
    mapDialog += "<div id='resertBtn' ontouchmove='move();' ontouchstart='begin();window.GameMainClass.playEffectSound(\"icon\");$(this).css({ \"-webkit-transform\": \"scale(0.8)\" });' ontouchend='if (!cancel()) {YxzResetSubmit(" + warindex + ");}$(this).css({ \"-webkit-transform\": \"scale(1)\" });' style='top:330px; right:170px; display:block;' class='LvUpBtn'><div class='btn'><div class='btn1'></div><div class='btn2'>重置</div><div class='btn3'></div></div></div>";
    mapDialog += "<div id='tzBtn' ontouchmove='move();' ontouchstart='begin();window.GameMainClass.playEffectSound(\"icon\");$(this).css({ \"-webkit-transform\": \"scale(0.8)\" });' ontouchend='if (!cancel()) {YxzFightSubmit(" + warindex + ");}$(this).css({ \"-webkit-transform\": \"scale(1)\" });' style='top:330px; right:50px;display:block;' class='LvUpBtn'><div class='btn'><div class='btn1'></div><div class='btn2'>挑战</div><div class='btn3'></div></div></div><div id='yxzDropDiv'></div>";

    var div = document.createElement("div");
    div.id = "yxzHeroInfo";
    $(div).css({ "left": (width - 516) / 2, "top": (height - 410) / 2 + 10 });
    div.innerHTML = mapDialog;
    $("body").append(div);

    div = document.createElement("div");
    div.className = "yxzbody";
    $(div).css({ "background-image": "url(res/yxz/body/" + yxzJson.data[warindex].warid + "a.png)", "top": 52, "left": 27 });
    $("#yxzHeroInfo").append(div);

    div = document.createElement("div");
    div.className = "yxzDetail";
    $(div).html("<font style='color:#ffff00;'>需消耗体力  </font><font style='color:#00ff00;'>" + yxzJson.data[warindex].cutstrength + "</font>");
    $(div).css({ "top": 290, "text-align": "center" });
    $("#yxzHeroInfo").append(div);

    div = document.createElement("div");
    div.className = "yxzDetail";
    $(div).html(yxzJson.data[warindex].detail);
    $(div).css({ "top": 310 });
    $("#yxzHeroInfo").append(div);

    div = document.createElement("div");
    div.className = "yxzDetail";
    $(div).html("每次战胜随机必掉其中一件物品");
    $(div).css({ "top": 40, "text-align": "center", "width": 276, "left": 0 });
    $("#yxzDropDiv").append(div);

    var itemlist = yxzJson.data[warindex].itemlist.split(",");
    var typelist = yxzJson.data[warindex].type.split(",");
    var len = GoodsJson.data.length;

    for (var i = 0; i < itemlist.length; i++) {
        switch (typelist[i]) {
            case "3":
                for (var j = 0; j < GoodsJson.data.length; j++) {
                    if (Number(itemlist[i]) == GoodsJson.data[j].ItemID) {
                        div = document.createElement("div");
                        div.className = "bagItem";
                        div.setAttribute("itemid", GoodsJson.data[j].ItemID)
                        div.innerHTML = "<div class='bagHeadBg2' style='top:70px;' ><div class='bagHead' style='background-image:url(res/goods/" + GoodsJson.data[j].ImgID + ".png);'></div><div class='bagHeadColor'></div></div>";

                        $(div).bind("touchstart", function () {
                            begin();
                        }).bind("touchmove", function () {
                            move();
                        }).bind("touchend", function () {
                            showLocalNormalGoodDetail($(this).attr("itemid"));
                        })

                        $("#yxzDropDiv").append(div);
                    }
                }
                break;
            case "2":
                for (var j = 0; j < localHeroJson.data.length; j++) {
                    if (Number(itemlist[i]) == localHeroJson.data[j].gid) {
                        div = document.createElement("div");
                        div.className = "bagItem";
                        div.setAttribute("sid", localHeroJson.data[j].gid);
                        div.innerHTML = "<div class='bagHeadBg2' style='top:70px;' ><div class='bagHead' style='background-image:url(res/head/" + localHeroJson.data[j].ImgID + ".png);'></div><div class='bagHeadColor' style='background-image:url(res/head/" + localHeroJson.data[j].q + ".png);'></div></div>";

                        $(div).bind("touchstart", function () {
                            begin();
                        }).bind("touchmove", function () {
                            move();
                        }).bind("touchend", function () {
                            showHeroDetailNormal($(this).attr("sid"));
                        })

                        $("#yxzDropDiv").append(div);
                    }
                }
                break;
        }
    }


    if (pad) $("#yxzHeroInfo").css({ "zoom": sp, "left": (width - 516 * sp) / 2 / sp, "top": ((height - 410 * sp) / 2 + 10) / sp });

    var maskDiv = document.createElement("div");
    maskDiv.id = "tempMask";
    $(maskDiv).css({ "width": width, "height": height, "top": "0","z-index":"2"});
    document.body.appendChild(maskDiv);
}

//提交开战
var YxzFightSubmit = function (warindex) {
    if (!yxzData.data[warindex].canPK) {
        showTextMess("当前状态为不可挑战", 0);
        return;
    }
    if (yxzJson.data[warindex].cutstrength > userJson.strength) {
        showTextMess("行动点不足", 0);
        return;
    }
    nowwarid = yxzData.data[warindex].warid;
    fighttype = 2;
    loadTake();
    $(this).css({ "-webkit-transform": "scale(1)" });
}

//提交重置
var YxzResetSubmit = function (warindex) {
    if (yxzData.data[warindex].canPK) {
        showTextMess("当前战役不需要重置", 0);
        return;
    }

    if (yxzData.leftRS < 1) {
        showTextMess("今日重置次数已尽", 0);
        return;
    }
    window.GameMainClass.playEffectSound("icon");
    nowwarid = 2;
    window.GameMainClass.sendRequestJson(166, '{"warid":' + yxzData.data[warindex].warid + '}', "YxzResetResult");
}

//重置结果
var YxzResetResult = function (json) {
    var BackJson = JSON.parse(json);
    if (BackJson.resert) {
        $("#yxzHeroInfo").remove();
        $("#tempMask").remove();
        yxzData.leftRS -= 1;

        for (var i = 0; i < yxzData.data.length; i++) {
            if (yxzData.data[i].warid == BackJson.Client[0].warid) {
                yxzData.data[i].canPK = 1;
                $("#yb" + i).css({ "background-image": "url(res/yxz/body/" + yxzJson.data[i].warid + "a.png)" });
                $("#yb" + i).html("");
                break;
            }
        }

        $("#rescount").html("重置关卡次数：<font style='color:#00ff00;'>" + yxzData.leftRS + "</font>");
    }
}

//打斗结果
var YxzFightResult = function (json) {
    var BackJson = JSON.parse(json);
    if (BackJson.resert) {
        $("#yxzHeroInfo").remove();
        $("#tempMask").remove();
        //减行动点，不管输赢都要减
        userJson.coin = BackJson.coin;

        if (userJson.coin >= 1000000)
            $("#u_coin").text(parseInt(userJson.coin / 10000) + "万");
        else
            $("#u_coin").text(userJson.coin);
        

        if (BackJson.iswin) {
            //更改用户数据
            userJson.lv = BackJson.upUJson.lv;
            if (userJson.lv != BackJson.upUJson.lv)
                $("#u_lv").html(getCityLv(userJson.lv));
            userJson.exp = BackJson.upUJson.exp;
            var tempExpWidth = (userJson.exp / lvUpJson.data[userJson.lv - 1].exp) * 96;
            $("#u_exp").css("width", parseInt(tempExpWidth)).children("#u_exp_content").text(parseInt(userJson.exp / lvUpJson.data[userJson.lv - 1].exp * 100) + "%");
            

            userJson.gnum = BackJson.upUJson.gnum;
            userJson.pnum = BackJson.upUJson.pnum;
            userJson.fspoint = BackJson.upUJson.fspoint;
            userJson.leader = BackJson.upUJson.leader;
            if (userJson.strength >= userJson.smax && BackJson.upUJson.strength < userJson.smax) {
                userJson.stime = 300;
            }

            userJson.strength = BackJson.upUJson.strength;
            var StrengWidth = parseInt((userJson.strength / userJson.smax) * 122) > userJson.smax ? userJson.smax : parseInt((userJson.strength / userJson.smax) * 122);
            $("#u_strength").css("width", StrengWidth).children("#u_strength_content").text(userJson.strength + "/" + userJson.smax + "");

            if (BackJson.isLvUp == 1)
                LvUpChange();

            //加物品
            if (BackJson.ware)
                AddItem(BackJson.ware);
            //加武将
            if (BackJson.gen) {
                for (var i = 0; i < BackJson.gen.length; i++)
                    heroJson.data.push(BackJson.gen[i]);
            }
            if (pieceJson != null) {
                if (BackJson.piece) {
                    for (var i = 0; i < BackJson.piece.length; i++) {
                        var tempPieceId = BackJson.piece[i].s.split(",")[0];
                        var tempFlag = false;
                        for (var j = 0; j < pieceJson.data.length; j++) {
                            if (pieceJson.data[j].s.split(",")[0] == tempPieceId) {
                                pieceJson.data[j].s = BackJson.piece[i].s;
                                tempFlag = true;
                                break;
                            }
                        }
                        if (!tempFlag) {
                            pieceJson.data.push(BackJson.piece[i]);
                        }
                    }
                }
            }
            

            //将这一关的boss变暗
            for (var i = 0; i < yxzData.data.length; i++) {
                if (yxzData.data[i].warid == BackJson.Client[0].warid) {
                    yxzData.data[i].canPK = 0;
                    $("#yb" + i).css({ "background-image": "url(res/yxz/body/" + BackJson.Client[0].warid + "b.png)" });
                    var div = document.createElement("div");
                    div.className = "yxzPassLabel";
                    $("#yb" + i).append(div);
                    break;
                }
            }

            //点亮下一个关卡
            if (BackJson.newWarID > 0) {
                var len = yxzData.data.length;
                yxzData.data.push({ "warid": BackJson.newWarID, "canPK": 1 });
                var i = len / 4;
                var x = yxzData.data.length - 1;
                if (len % 4 == 0) {//加一页 
                    ShowYxzMap(yxzNowPage + 1);

                }
                else {
                    var div = document.createElement("div");
                    div.className = "yxzbody";
                    div.id = "yb" + x;
                    $(div).css({ "background-image": "url(res/yxz/body/" + yxzJson.data[x].warid + "a.png)", "left": yxzJson.data[x].x, "top": yxzJson.data[x].y });

                    //绑定事件
                    $(div).bind("touchend", function () {
                        if (!cancel()) {
                            showYxzHeroInfo(x);
                            window.GameMainClass.playEffectSound("close");
                        }
                        $(this).css({ "-webkit-transform": "scale(1)" });
                    }).bind("touchmove", function () {
                        $(this).css({ "-webkit-transform": "scale(1)" });
                        move();
                    }).bind("touchstart", function () {
                        begin();
                        $(this).css({ "-webkit-transform": "scale(0.8)" });
                    });

                    $("#yxzMap").append(div);
                }
            }
        }

        friendEnd(BackJson.friend,BackJson.iswin);
    }
    else
        showTextMess(BackJson.info, 0);
}

var bugYxzTime = function (json) {
    var tempJson = JSON.parse(json);
    if (tempJson.resert != 1) {
        showTextMess(tempJson.info, 2);
    }
    else {
        showTextMess(tempJson.info, 1);
        yxzData.leftbuy--;
        updateUserJson("600", 0 - tempJson.gold);
        yxzData.leftRS++;
        $("#rescount").html("重置关卡次数：<font style='color:#00ff00;'>" + yxzData.leftRS + "</font>");
        $("#temp").html("");
        $("#tempMask").remove();
    }
}